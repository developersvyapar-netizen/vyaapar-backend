// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// User Roles Enum
enum UserRole {
  ADMIN
  DEVELOPER
  STOCKIST
  DISTRIBUTOR
  RETAILER
  SALESPERSON
}

// Order Status Enum
enum OrderStatus {
  PENDING
  APPROVED
  REJECTED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

// Attendance Status Enum
enum AttendanceStatus {
  LOGGED_IN
  LOGGED_OUT
  INCOMPLETE
}

// User Model - All roles including admin
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  loginId   String   @unique // Unique login ID for authentication
  password  String   // Hashed password (never stored in plain text)
  name      String?
  role      UserRole @default(RETAILER)
  phone     String?
  address   String?
  isActive  Boolean  @default(true)
  
  // Relationships
  createdBy String? // ID of admin/developer who created this user
  creator   User?   @relation("UserCreator", fields: [createdBy], references: [id])
  createdUsers User[] @relation("UserCreator")
  
  // Orders where this user is the buyer/requester
  ordersAsBuyer Order[] @relation("OrderBuyer")
  
  // Orders where this user is the supplier
  ordersAsSupplier Order[] @relation("OrderSupplier")
  
  // Orders where this user is the salesperson
  ordersAsSalesperson Order[] @relation("OrderSalesperson")
  
  // Stock inventory for this user (Distributors, Stockists, Admin)
  inventory Inventory[]
  
  // Attendance logs for salespersons
  attendanceLogs AttendanceLog[] @relation("SalespersonAttendance")

  // Cart (one per salesperson)
  cart Cart? @relation("SalespersonCart")
  cartsAsBuyer Cart[] @relation("CartBuyer")
  cartsAsSupplier Cart[] @relation("CartSupplier")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
  @@index([role])
  @@index([email])
  @@index([loginId])
}

// Product/Item Model
model Product {
  id          String   @id @default(uuid())
  name        String
  description String?
  sku         String   @unique
  price       Decimal  @db.Decimal(10, 2)
  unit        String?  // e.g., "kg", "piece", "box"
  
  // Relationships
  orderLines  OrderLine[]
  inventory   Inventory[]
  mainStock   MainStock?  // Admin's main warehouse stock
  cartItems   CartItem[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("products")
  @@index([sku])
  @@index([name])
}

// Main Stock Inventory Model - Admin's central warehouse stock
// Admin adds items here to manage the main inventory
model MainStock {
  id        String   @id @default(uuid())
  
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  
  quantity  Int      @default(0)
  
  // Tracking who added/updated stock
  lastUpdatedBy String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId])
  @@map("main_stock")
  @@index([productId])
}

// Inventory Model - Tracks stock for Distributors, Stockists, and Admin
// When Admin supplies to Stockists, it comes from MainStock
model Inventory {
  id        String   @id @default(uuid())
  
  userId    String   // Distributor, Stockist, or Admin
  user      User     @relation(fields: [userId], references: [id])
  
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  
  quantity  Int      @default(0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, productId])
  @@map("inventory")
  @@index([userId])
  @@index([productId])
}

// Order Model
// Represents a purchase order from buyer to supplier
// Examples:
// - Retailer (buyer) -> Distributor (supplier)
// - Distributor (buyer) -> Stockist (supplier)
// - Stockist (buyer) -> Admin (supplier)
model Order {
  id            String      @id @default(uuid())
  orderNumber   String      @unique
  
  // Buyer (retailer, distributor, or stockist)
  buyerId       String
  buyer         User        @relation("OrderBuyer", fields: [buyerId], references: [id])
  
  // Supplier (distributor, stockist, or admin)
  supplierId    String
  supplier      User        @relation("OrderSupplier", fields: [supplierId], references: [id])
  
  // Salesperson who created the order on behalf of buyer (null for self-orders)
  salespersonId String?
  salesperson   User?       @relation("OrderSalesperson", fields: [salespersonId], references: [id])
  
  status        OrderStatus @default(PENDING)
  totalAmount   Decimal     @db.Decimal(10, 2) @default(0)
  notes         String?
  
  // Order lines
  orderLines    OrderLine[]
  
  // Approval tracking
  approvedAt    DateTime?
  approvedBy    String?     // User ID who approved
  
  // Cancellation tracking (only SALESPERSON or ADMIN can cancel)
  cancelledAt   DateTime?
  cancelledBy   String?     // User ID who cancelled (must be SALESPERSON or ADMIN)
  cancelReason  String?
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@map("orders")
  @@index([buyerId])
  @@index([supplierId])
  @@index([salespersonId])
  @@index([status])
  @@index([orderNumber])
}

// Cart Model - Session-based cart for salesperson before creating order
model Cart {
  id            String    @id @default(uuid())
  salespersonId String    @unique
  salesperson   User      @relation("SalespersonCart", fields: [salespersonId], references: [id], onDelete: Cascade)
  buyerId       String?
  buyer         User?     @relation("CartBuyer", fields: [buyerId], references: [id], onDelete: SetNull)
  supplierId    String?
  supplier      User?     @relation("CartSupplier", fields: [supplierId], references: [id], onDelete: SetNull)
  items         CartItem[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("carts")
  @@index([salespersonId])
}

// Cart Item Model - Items in cart with quantity and snapshot price
model CartItem {
  id        String   @id @default(uuid())
  cartId    String
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  quantity  Int
  unitPrice Decimal  @db.Decimal(10, 2) // Price at time of adding to cart
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cartId, productId])
  @@map("cart_items")
  @@index([cartId])
  @@index([productId])
}

// Order Line Model - Individual items in an order
model OrderLine {
  id            String   @id @default(uuid())
  orderId       String
  order         Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  productId     String
  product       Product  @relation(fields: [productId], references: [id])
  
  quantity      Int
  unitPrice     Decimal  @db.Decimal(10, 2)
  totalPrice    Decimal  @db.Decimal(10, 2)
  
  notes         String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("order_lines")
  @@index([orderId])
  @@index([productId])
}

// Attendance Log Model - Tracks salesperson daily login/logout times
model AttendanceLog {
  id            String           @id @default(uuid())
  
  salespersonId String
  salesperson   User             @relation("SalespersonAttendance", fields: [salespersonId], references: [id])
  
  loginTime     DateTime
  logoutTime    DateTime?
  date          DateTime         @db.Date // Store date only (without time)
  totalHours    Decimal?         @db.Decimal(5, 2) // Calculated hours worked
  status        AttendanceStatus @default(LOGGED_IN)
  
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  @@unique([salespersonId, date])
  @@map("attendance_logs")
  @@index([salespersonId])
  @@index([date])
  @@index([status])
}